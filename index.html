<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Laudos - UBS Santo Afonso</title>
    
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        console.error(error);
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = `
            <div style="color: #ff4444; background: #1a1a1a; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <h1 style="font-size: 24px; margin-bottom: 10px;">Erro ao carregar o sistema</h1>
              <p style="font-size: 16px; opacity: 0.8;">${message}</p>
              <p style="font-size: 12px; opacity: 0.5; margin-top: 10px;">Linha: ${lineno} | Fonte: ${source}</p>
              <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #00c3ff; border: none; border-radius: 5px; color: white; cursor: pointer;">Tentar Novamente</button>
            </div>
          `;
        }
      };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script crossorigin src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#00c3ff',
              'brand-secondary': '#ff00aa',
              'brand-accent': '#00ff95',
              'brand-dark': '#121212',
              'brand-light-gray': '#282828',
              'brand-gray': '#181818',
              'danger': '#e53e3e',
              'warning': '#dd6b20',
            },
            boxShadow: {
              '3d': '0 5px 15px rgba(0, 0, 0, 0.3)',
              '3d-hover': '0 8px 25px rgba(0, 0, 0, 0.4)',
            },
            aspectRatio: {
              'video': '16 / 9',
            },
            keyframes: {
              'pop-in': { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
              'slide-in-left': { '0%': { opacity: '0', transform: 'translateX(-100px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
              'fade-in': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            },
            animation: {
              'pop-in': 'pop-in 0.3s ease-out forwards',
              'slide-in-left': 'slide-in-left 0.5s ease-out forwards',
              'fade-in': 'fade-in 0.5s ease-out forwards',
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-brand-dark text-white">
    <div id="root" class="flex h-screen w-full items-center justify-center">
      <div class="text-center animate-pulse">
        <svg class="w-12 h-12 mx-auto mb-4 text-brand-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <p class="text-xl font-bold">Carregando Sistema...</p>
      </div>
    </div>

    <script type="text/babel">
      // Acessando as bibliotecas globais carregadas no head
      const { useState, useEffect, useCallback, useContext, useMemo, createContext } = React;
      const { createRoot } = ReactDOM;
      const { createClient } = supabase;

      // --- Enums e Constantes ---
      const TestType = {
          DENGUE: "DENGUE - NS1",
          COVID: "COVID-19 - ANTÍGENO",
          HCG: "HCG - BETA-HCG"
      };

      const DengueResult = {
          NEGATIVE: "NEGATIVO",
          IGG_REAGENT: "IGG REAGENTE",
          IGM_REAGENT: "IGM REAGENTE",
          IGG_IGM_REAGENT: "IGG E IGM REAGENTES"
      };

      const CovidResult = {
          NEGATIVE: "NEGATIVO",
          POSITIVE: "POSITIVO"
      };

      // --- Configuração Supabase ---
      const supabaseUrl = 'https://avcpoeouasfeuqsbyuoy.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2Y3BvZW91YXNmZXVxc2J5dW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTkxMjIsImV4cCI6MjA3NzA3NTEyMn0.0eF-yCEBAuHl8B3ORN7VYfJnnEIY0m1bMj8R_FsntNM';
      const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

      // --- Contexto ---
      const AppContext = createContext({
        reports: [],
        stock: [],
        indicators: [],
        isInventoryUnlocked: false,
        setIsInventoryUnlocked: () => {},
        addReport: async () => {},
        updateReport: async () => {},
        deleteReport: async () => {},
        addStockItem: async () => {},
        updateStockItem: async () => {},
        deleteStockItem: async () => {},
        addIndicator: async () => {},
        updateIndicator: async () => {},
        deleteIndicator: async () => {},
      });

      // --- Ícones ---
      const iconClass = "h-6 w-6";
      const HomeIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>);
      const DocumentReportIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
      const ArchiveIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>);
      const ChartBarIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>);
      const AlertIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>);
      const DocumentTextIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>);
      const PlusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>);
      const PencilIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>);
      const TrashIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>);
      const DownloadIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>);

      // --- Componentes ---

      const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 animate-pop-in p-4">
            <div className="bg-gray-800 rounded-2xl shadow-3d w-full max-w-md border border-gray-700/50">
              <div className="p-5 space-y-4">
                <h2 className="text-2xl font-bold text-white">{title}</h2>
                <p className="text-gray-300">{message}</p>
                <div className="flex justify-end space-x-4 pt-4">
                  <button onClick={onClose} className="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Cancelar</button>
                  <button onClick={onConfirm} className="py-2 px-4 bg-danger hover:bg-opacity-80 text-white font-bold rounded-lg transition">Confirmar Exclusão</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const PasswordModal = ({ isOpen, onClose, onConfirm, title, message }) => {
        const [password, setPassword] = useState('');
        if (!isOpen) return null;
        const handleSubmit = (e) => { e.preventDefault(); onConfirm(password); };
        return (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 animate-pop-in p-4">
            <div className="bg-gray-800 rounded-2xl shadow-3d w-full max-w-md border border-gray-700/50">
              <form onSubmit={handleSubmit} className="p-5 space-y-4">
                <h2 className="text-2xl font-bold text-white">{title}</h2>
                <p className="text-gray-300">{message}</p>
                <div>
                  <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-brand-secondary" placeholder="Digite a senha" autoFocus />
                </div>
                <div className="flex justify-end space-x-4 pt-4">
                  <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Cancelar</button>
                  <button type="submit" className="py-2 px-4 bg-brand-secondary hover:bg-opacity-80 text-white font-bold rounded-lg transition">Acessar</button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const StockFormModal = ({ isOpen, onClose, itemToEdit }) => {
        const { addStockItem, updateStockItem } = useContext(AppContext);
        const [formData, setFormData] = useState({ test_type: TestType.DENGUE, lote: '', validade: '', quantity: 0 });

        useEffect(() => {
          if (itemToEdit) {
            setFormData({ test_type: itemToEdit.test_type, lote: itemToEdit.lote, validade: itemToEdit.validade, quantity: itemToEdit.quantity });
          } else {
            setFormData({ test_type: TestType.DENGUE, lote: '', validade: '', quantity: 0 });
          }
        }, [itemToEdit, isOpen]);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: name === 'quantity' ? (parseInt(value, 10) || 0) : (e.target.type === 'text' ? value.toUpperCase() : value) }));
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          try {
            if (itemToEdit) await updateStockItem(itemToEdit.id, formData);
            else await addStockItem(formData);
            onClose();
          } catch(error) { alert("Falha ao salvar o item de estoque."); }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 animate-pop-in">
            <div className="bg-gray-800 rounded-2xl shadow-3d w-full max-w-md border border-gray-700/50">
              <form onSubmit={handleSubmit} className="p-5 space-y-3">
                <h2 className="text-2xl font-bold text-white pb-2">{itemToEdit ? 'Editar Item' : 'Adicionar ao Estoque'}</h2>
                <div>
                  <label className="block text-sm font-medium text-gray-300">Tipo de Teste</label>
                  <select name="test_type" value={formData.test_type} onChange={handleChange} className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3">{Object.values(TestType).map(type => <option key={type} value={type}>{type}</option>)}</select>
                </div>
                <div><label className="block text-sm font-medium text-gray-300">Lote</label><input type="text" name="lote" value={formData.lote} onChange={handleChange} required className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3"/></div>
                <div><label className="block text-sm font-medium text-gray-300">Validade</label><input type="date" name="validade" value={formData.validade} onChange={handleChange} required className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3"/></div>
                <div><label className="block text-sm font-medium text-gray-300">Quantidade</label><input type="number" name="quantity" min="0" value={formData.quantity} onChange={handleChange} required className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3"/></div>
                <div className="flex justify-end space-x-4 pt-3"><button type="button" onClick={onClose} className="py-2 px-4 bg-gray-600 rounded-lg">Cancelar</button><button type="submit" className="py-2 px-4 bg-brand-secondary text-white font-bold rounded-lg">Salvar</button></div>
              </form>
            </div>
          </div>
        );
      };

      const ReportPDF = ({ report, onDone }) => {
        useEffect(() => {
          const timer = setTimeout(() => {
            const reportElement = document.getElementById('printable-report-for-pdf');
            if (!reportElement || !window.html2canvas || !window.jspdf) {
              alert("Erro ao preparar PDF."); onDone(); return;
            }
            const { jsPDF } = window.jspdf;
            window.html2canvas(reportElement, { scale: 3, useCORS: true, logging: false }).then((canvas) => {
              const imgData = canvas.toDataURL('image/png');
              const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
              const pdfWidth = pdf.internal.pageSize.getWidth();
              const imgHeight = (canvas.height * pdfWidth) / canvas.width;
              pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
              
              // Sanitiza nome do arquivo
              const safeName = report.patient_name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
              const safeDate = new Date(report.report_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}).replace(/\//g, '-');
              pdf.save(`laudo_${safeName}_${safeDate}.pdf`);
              
              onDone();
            }).catch((err) => { console.error(err); alert("Erro ao gerar PDF."); onDone(); });
          }, 500);
          return () => clearTimeout(timer);
        }, [report, onDone]);

        const renderField = (label, value) => (
          <div className="flex items-baseline"><span className="font-semibold mr-2">{label}</span><span className="flex-1 border-b border-dotted border-black text-left pb-1">{value || ''}</span></div>
        );

        const CommonHeader = ({ title }) => (
          <>
            <header className="text-center mb-6"><h1 className="text-2xl font-bold">UBS SANTO AFONSO</h1></header>
            <section className="text-center my-8"><h1 className="text-lg font-bold uppercase">{title}</h1></section>
          </>
        );

        const CommonPatientInfo = ({ r }) => (
          <section className="space-y-3 mb-6 text-sm">
            {renderField("Nome do usuário:", r.patient_name)}
            {r.test_type === TestType.HCG ? renderField("Prontuário:", r.prontuario) : renderField("Identidade/CPF:", r.patient_id)}
            <div className="flex space-x-8"><div className="w-1/2">{renderField("Data de Nascimento:", new Date(r.birth_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}))}</div><div className="w-1/2">{renderField("Sexo:", r.sex)}</div></div>
            {renderField("Unidade de realização do exame:", r.execution_unit)}
            {r.test_type === TestType.DENGUE && renderField("Data do início dos sintomas:", new Date(r.symptom_start_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}))}
            {r.test_type === TestType.COVID && renderField("Cidade:", r.city)}
            {renderField("Data da coleta da amostra:", new Date(r.sample_collection_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}))}
          </section>
        );

        const CommonFooter = ({ r }) => (
          <footer className="mt-auto pt-12 text-sm">
            <div className="flex justify-between items-end">
              <div className="text-center"><div className="w-80 border-t-2 border-black mb-1"></div><p className="font-semibold uppercase">{r.technician_name}</p><p>Técnico Responsável</p></div>
              <div><p className="font-semibold">Data do Laudo: {new Date(r.report_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p></div>
            </div>
            <p className="text-xs text-gray-700 text-center mt-6">Este laudo foi gerado eletronicamente. Confirme as informações com o profissional de saúde.</p>
            <div className="text-center mt-8 pt-4 border-t border-black" style={{fontSize: '8pt'}}><p className="font-bold">Desenvolvido por: Jaime Eduardo | Whats: 51985502897</p></div>
          </footer>
        );

        const ResultBox = ({ result }) => (
          <section className="border border-black mt-6 p-2" style={{ backgroundColor: '#f0f0f0' }}>
            <div className="text-right font-semibold text-lg">Resultado</div>
            <div className="text-center text-3xl font-bold my-4 uppercase">{result}</div>
          </section>
        );

        const Template = () => {
          return (
            <div className="p-10 text-black flex flex-col min-h-full" style={{ fontSize: '10pt', fontFamily: 'Arial, sans-serif' }}>
              <CommonHeader title={report.test_type} />
              <CommonPatientInfo r={report} />
              <section className="border-2 border-black text-sm">
                <div className="p-2 border-b-2 border-black"><strong>Amostra:</strong> {report.sample_type}</div>
                <div className="p-2 border-b-2 border-black"><strong>Teste:</strong> {report.test_type} {report.manufacturer ? `(${report.manufacturer})` : ''}</div>
                <div className="flex border-b-2 border-black"><div className="w-1/2 p-2 border-r-2 border-black"><strong>Lote:</strong> {report.lote}</div><div className="w-1/2 p-2"><strong>Validade:</strong> {new Date(report.validade).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</div></div>
                <div className="p-2"><strong>Método:</strong> {report.method}</div>
              </section>
              <ResultBox result={report.test_type === TestType.HCG ? report.result_value : report.result} />
              <div className="flex-grow"></div>
              <CommonFooter r={report} />
            </div>
          );
        };

        return (
          <>
            <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[1000] animate-fade-in"><div className="bg-brand-secondary text-white font-bold py-4 px-6 rounded-xl shadow-3d flex items-center">Gerando arquivo PDF...</div></div>
            <div className="absolute top-0 -left-[9999px] z-0"><div id="printable-report-for-pdf" className="bg-white w-[210mm] min-h-[297mm] flex flex-col"><Template /></div></div>
          </>
        );
      };

      const ReportFormModal = ({ isOpen, onClose, reportToEdit }) => {
        const { addReport, updateReport, stock } = useContext(AppContext);
        const [formData, setFormData] = useState({});

        useEffect(() => {
          const today = new Date().toISOString().split('T')[0];
          if (reportToEdit) { setFormData({ ...reportToEdit }); }
          else {
            setFormData({
              test_type: TestType.DENGUE, patient_name: '', patient_id: '', birth_date: '', sex: 'Feminino',
              execution_unit: '', sample_collection_date: today, technician_name: '', report_date: today,
              lote: '', validade: '', symptom_start_date: today, sample_type: 'punção digital',
              method: 'IMUNOCROMATOGRAFIA', result: DengueResult.NEGATIVE, city: '', manufacturer: '',
              prontuario: '', result_value: '',
            });
          }
        }, [reportToEdit, isOpen]);

        const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: (e.target.type === 'text' ? value.toUpperCase() : value) })); };

        const handleTestTypeChange = (e) => {
          const type = e.target.value;
          const today = new Date().toISOString().split('T')[0];
          setFormData(prev => ({ ...prev, test_type: type, result_value: '', result: type === TestType.COVID ? CovidResult.NEGATIVE : DengueResult.NEGATIVE }));
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!reportToEdit && (!formData.lote || !formData.validade)) { alert("Selecione um lote."); return; }
          try {
            const dataToSave = { ...formData };
            // Limpa campos vazios baseados no tipo
            if (dataToSave.test_type !== TestType.DENGUE) delete dataToSave.symptom_start_date;
            
            if (reportToEdit) await updateReport(reportToEdit.id, dataToSave);
            else await addReport(dataToSave);
            onClose();
          } catch (error) { alert("Erro ao salvar."); }
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 animate-pop-in p-4">
            <div className="bg-gray-800 rounded-2xl shadow-3d w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray-700/50">
              <form onSubmit={handleSubmit} className="p-5">
                <h2 className="text-2xl font-bold text-white mb-4">{reportToEdit ? 'Editar Laudo' : 'Novo Laudo'}</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="md:col-span-2">
                    <label className="block text-sm text-gray-300">Tipo de Teste</label>
                    <select name="test_type" value={formData.test_type} onChange={handleTestTypeChange} className="mt-1 w-full bg-gray-700 border-gray-600 rounded p-2">{Object.values(TestType).map(t => <option key={t} value={t}>{t}</option>)}</select>
                  </div>
                  <div className="md:col-span-2"><label className="block text-sm text-gray-300">Nome do Paciente</label><input name="patient_name" value={formData.patient_name || ''} onChange={handleChange} required className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                  <div><label className="block text-sm text-gray-300">Identidade/CPF</label><input name="patient_id" value={formData.patient_id || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                  <div><label className="block text-sm text-gray-300">Nascimento</label><input type="date" name="birth_date" value={formData.birth_date || ''} onChange={handleChange} required className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                  <div><label className="block text-sm text-gray-300">Sexo</label><select name="sex" value={formData.sex || 'Feminino'} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select></div>
                  <div><label className="block text-sm text-gray-300">Unidade</label><input name="execution_unit" value={formData.execution_unit || ''} onChange={handleChange} required className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                  <div><label className="block text-sm text-gray-300">Técnico</label><input name="technician_name" value={formData.technician_name || ''} onChange={handleChange} required className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                  <div><label className="block text-sm text-gray-300">Data Coleta</label><input type="date" name="sample_collection_date" value={formData.sample_collection_date || ''} onChange={handleChange} required className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>

                  {/* Campos Específicos */}
                  {formData.test_type === TestType.DENGUE && (
                    <>
                      <div><label className="block text-sm text-gray-300">Início Sintomas</label><input type="date" name="symptom_start_date" value={formData.symptom_start_date || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                      <div><label className="block text-sm text-gray-300">Resultado</label><select name="result" value={formData.result} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2">{Object.values(DengueResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                    </>
                  )}
                  {formData.test_type === TestType.COVID && (
                    <>
                      <div><label className="block text-sm text-gray-300">Cidade</label><input name="city" value={formData.city || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                      <div><label className="block text-sm text-gray-300">Fabricante</label><input name="manufacturer" value={formData.manufacturer || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                      <div><label className="block text-sm text-gray-300">Resultado</label><select name="result" value={formData.result} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2">{Object.values(CovidResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                    </>
                  )}
                  {formData.test_type === TestType.HCG && (
                    <>
                      <div><label className="block text-sm text-gray-300">Prontuário</label><input name="prontuario" value={formData.prontuario || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2"/></div>
                      <div>
                        <label className="block text-sm text-gray-300">Resultado / Valor</label>
                        <select name="result_value" value={formData.result_value || ''} onChange={handleChange} className="w-full bg-gray-700 border-gray-600 rounded p-2">
                          <option value="">Selecione...</option>
                          <option value="POSITIVO">POSITIVO</option>
                          <option value="NEGATIVO">NEGATIVO</option>
                        </select>
                      </div>
                    </>
                  )}

                  {!reportToEdit && (
                    <div className="md:col-span-2">
                      <label className="block text-sm text-gray-300">Lote do Estoque</label>
                      <select name="lote" value={formData.lote} onChange={(e) => {
                        const sItem = stock.find(item => item.lote === e.target.value && item.test_type === formData.test_type);
                        setFormData(prev => ({ ...prev, lote: e.target.value, validade: sItem ? sItem.validade : '' }));
                      }} className="w-full bg-gray-700 border-gray-600 rounded p-2">
                        <option value="">Selecione...</option>
                        {stock.filter(i => i.test_type === formData.test_type && i.quantity > 0).map(i => <option key={i.id} value={i.lote}>{i.lote} (Qtd: {i.quantity})</option>)}
                      </select>
                    </div>
                  )}
                </div>
                <div className="flex justify-end space-x-4 pt-4">
                  <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-600 rounded">Cancelar</button>
                  <button type="submit" className="py-2 px-4 bg-brand-secondary rounded font-bold">Salvar</button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const Sidebar = ({ currentPage, setPage }) => {
        const { isInventoryUnlocked, setIsInventoryUnlocked } = useContext(AppContext);
        const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
        const navItems = [
          { page: 'dashboard', label: 'Dashboard', icon: <HomeIcon /> },
          { page: 'reports', label: 'Laudos', icon: <DocumentReportIcon /> },
          { page: 'inventory', label: 'Estoque', icon: <ArchiveIcon /> },
          { page: 'indicators', label: 'Indicadores', icon: <ChartBarIcon /> },
        ];
        return (
          <>
            <aside className="w-16 sm:w-64 bg-black bg-opacity-20 backdrop-blur-lg border-r border-gray-700/50 flex flex-col transition-all duration-300 animate-slide-in-left">
              <div className="h-20 flex items-center px-4"><span className="text-brand-secondary font-bold text-xl">UBS</span><span className="hidden sm:block ml-2 font-bold">SANTO AFONSO</span></div>
              <nav className="flex-1 mt-6">
                <ul>{navItems.map(item => (
                  <li key={item.page} className="px-4 mb-2">
                    <button onClick={() => { if(item.page === 'inventory' && !isInventoryUnlocked) setIsPasswordModalOpen(true); else setPage(item.page); }}
                      className={`flex items-center w-full p-3 rounded-lg transition-all ${currentPage === item.page ? 'bg-brand-secondary text-white' : 'text-gray-300 hover:bg-brand-primary hover:text-white'}`}>
                      {item.icon}<span className="hidden sm:block ml-4">{item.label}</span>
                    </button>
                  </li>
                ))}</ul>
              </nav>
            </aside>
            <PasswordModal isOpen={isPasswordModalOpen} onClose={() => setIsPasswordModalOpen(false)} onConfirm={(pwd) => { if(pwd === '159753') { setIsInventoryUnlocked(true); setPage('inventory'); setIsPasswordModalOpen(false); } else alert("Senha incorreta"); }} title="Acesso Restrito" message="Senha para o estoque:" />
          </>
        );
      };

      const Dashboard = ({ setPage }) => {
        const { reports, stock } = useContext(AppContext);
        const lowStock = stock.filter(i => i.quantity <= 5);
        const recent = reports.slice(0, 5);
        return (
          <div className="animate-fade-in space-y-8">
            <header className="flex justify-between items-center"><h1 className="text-4xl font-bold">Dashboard</h1><button onClick={() => setPage('reports')} className="bg-brand-secondary px-4 py-2 rounded flex items-center gap-2"><PlusIcon /> Novo Laudo</button></header>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-gray-800/50 p-6 rounded shadow-3d flex items-center gap-4 border border-gray-700"><div className="p-3 rounded-full bg-brand-primary/30"><DocumentTextIcon /></div><div><p className="text-gray-400">Total Laudos</p><p className="text-2xl font-bold">{reports.length}</p></div></div>
              <div className="bg-gray-800/50 p-6 rounded shadow-3d flex items-center gap-4 border border-gray-700"><div className="p-3 rounded-full bg-brand-accent/30"><ArchiveIcon /></div><div><p className="text-gray-400">Itens Estoque</p><p className="text-2xl font-bold">{stock.reduce((a,b)=>a+b.quantity,0)}</p></div></div>
              <div className="bg-gray-800/50 p-6 rounded shadow-3d flex items-center gap-4 border border-gray-700"><div className="p-3 rounded-full bg-warning/30"><AlertIcon /></div><div><p className="text-gray-400">Estoque Baixo</p><p className="text-2xl font-bold">{lowStock.length}</p></div></div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="bg-gray-800/50 p-6 rounded shadow-3d border border-gray-700">
                <h2 className="text-xl font-bold mb-4 text-brand-accent">Alerta de Estoque</h2>
                <ul className="space-y-3">{lowStock.map(i => <li key={i.id} className="flex justify-between bg-gray-700/50 p-3 rounded"><span>{i.test_type.split(' - ')[0]}</span><span className="bg-danger px-2 rounded font-bold">{i.quantity}</span></li>)}</ul>
              </div>
              <div className="lg:col-span-2 bg-gray-800/50 p-6 rounded shadow-3d border border-gray-700">
                <h2 className="text-xl font-bold mb-4 text-brand-accent">Recentes</h2>
                <table className="w-full text-left">
                  <thead><tr className="border-b border-gray-600"><th>Paciente</th><th>Teste</th><th>Data</th></tr></thead>
                  <tbody>{recent.map(r => <tr key={r.id} className="border-b border-gray-700"><td className="p-2">{r.patient_name}</td><td>{r.test_type}</td><td>{new Date(r.report_date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td></tr>)}</tbody>
                </table>
              </div>
            </div>
            <div className="mt-8"><img src="https://www.tjpb.jus.br/sites/default/files/media/2022/12/WhatsApp_Image_2022-12-01_at_10.37.10.jpeg" className="rounded-lg shadow-3d w-full object-cover border border-gray-700/50 aspect-video" /></div>
          </div>
        );
      };

      const Reports = () => {
        const { reports, deleteReport } = useContext(AppContext);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editing, setEditing] = useState(null);
        const [deleting, setDeleting] = useState(null);
        const [printing, setPrinting] = useState(null);
        const [search, setSearch] = useState('');

        const filtered = reports.filter(r => r.patient_name.toLowerCase().includes(search.toLowerCase()) || r.test_type.toLowerCase().includes(search.toLowerCase()));

        return (
          <div className="animate-fade-in space-y-6">
            <header className="flex justify-between"><h1 className="text-4xl font-bold">Laudos</h1><button onClick={() => { setEditing(null); setIsModalOpen(true); }} className="bg-brand-secondary px-4 py-2 rounded flex gap-2"><PlusIcon /> Novo</button></header>
            <input placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-gray-800 border-gray-700 rounded p-3" />
            <div className="bg-gray-800/50 rounded shadow-3d overflow-x-auto">
              <table className="w-full text-left">
                <thead><tr className="bg-black/20"><th className="p-4">Paciente</th><th className="p-4">Teste</th><th className="p-4">Data</th><th className="p-4">Ações</th></tr></thead>
                <tbody>{filtered.map(r => (
                  <tr key={r.id} className="border-b border-gray-700 hover:bg-gray-700/30">
                    <td className="p-4">{r.patient_name}</td><td className="p-4">{r.test_type}</td><td className="p-4">{new Date(r.report_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                    <td className="p-4 flex gap-2">
                      <button onClick={() => setPrinting(r)} className="p-2 hover:text-brand-primary"><DownloadIcon /></button>
                      <button onClick={() => { setEditing(r); setIsModalOpen(true); }} className="p-2 hover:text-brand-secondary"><PencilIcon /></button>
                      <button onClick={() => setDeleting(r)} className="p-2 hover:text-danger"><TrashIcon /></button>
                    </td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
            {isModalOpen && <ReportFormModal isOpen={true} onClose={() => setIsModalOpen(false)} reportToEdit={editing} />}
            {deleting && <ConfirmationModal isOpen={true} onClose={() => setDeleting(null)} onConfirm={async () => { await deleteReport(deleting.id); setDeleting(null); }} title="Excluir" message="Tem certeza?" />}
            {printing && <ReportPDF report={printing} onDone={() => setPrinting(null)} />}
          </div>
        );
      };

      const Inventory = () => {
        const { stock, deleteStockItem } = useContext(AppContext);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editing, setEditing] = useState(null);
        const [deleting, setDeleting] = useState(null);
        
        return (
          <div className="animate-fade-in space-y-6">
            <header className="flex justify-between"><h1 className="text-4xl font-bold">Estoque</h1><button onClick={() => { setEditing(null); setIsModalOpen(true); }} className="bg-brand-secondary px-4 py-2 rounded flex gap-2"><PlusIcon /> Adicionar</button></header>
            <div className="bg-gray-800/50 rounded shadow-3d overflow-x-auto">
              <table className="w-full text-left">
                <thead><tr className="bg-black/20"><th className="p-4">Teste</th><th className="p-4">Lote</th><th className="p-4">Validade</th><th className="p-4">Qtd</th><th className="p-4">Ações</th></tr></thead>
                <tbody>{stock.map(i => (
                  <tr key={i.id} className="border-b border-gray-700 hover:bg-gray-700/30">
                    <td className="p-4">{i.test_type}</td><td className="p-4">{i.lote}</td><td className="p-4">{new Date(i.validade).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td><td className="p-4 font-bold">{i.quantity}</td>
                    <td className="p-4 flex gap-2">
                      <button onClick={() => { setEditing(i); setIsModalOpen(true); }} className="p-2 hover:text-brand-secondary"><PencilIcon /></button>
                      <button onClick={() => setDeleting(i)} className="p-2 hover:text-danger"><TrashIcon /></button>
                    </td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
            {isModalOpen && <StockFormModal isOpen={true} onClose={() => setIsModalOpen(false)} itemToEdit={editing} />}
            {deleting && <ConfirmationModal isOpen={true} onClose={() => setDeleting(null)} onConfirm={async () => { await deleteStockItem(deleting.id); setDeleting(null); }} title="Excluir" message="Confirma exclusão?" />}
          </div>
        );
      };

      const Indicators = () => {
        const { indicators, addIndicator, updateIndicator, deleteIndicator } = useContext(AppContext);
        const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' });
        const [editing, setEditing] = useState(null);
        const [deleting, setDeleting] = useState(null);

        useEffect(() => { if(editing) setFormData(editing); else setFormData({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' }); }, [editing]);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if(editing) { await updateIndicator(editing.id, formData); setEditing(null); } else { await addIndicator(formData); }
          setFormData({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' });
        };

        const exportCSV = () => {
          const csv = "Data,G'mus,Pressao,HGT,Peso,Altura,Profissional\n" + indicators.map(i => `${i.date},${i.gmus},${i.pressure},${i.hgt},${i.weight},${i.height},${i.professional}`).join('\n');
          const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "indicadores.csv"; link.click();
        };

        return (
          <div className="animate-fade-in space-y-6">
            <h1 className="text-4xl font-bold">Indicadores</h1>
            <div className="bg-gray-800/50 p-6 rounded shadow-3d border border-gray-700">
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="bg-gray-700 rounded p-2" required />
                <input placeholder="G'mus" value={formData.gmus} onChange={e => setFormData({...formData, gmus: e.target.value})} className="bg-gray-700 rounded p-2" required />
                <input placeholder="Pressão" value={formData.pressure} onChange={e => setFormData({...formData, pressure: e.target.value})} className="bg-gray-700 rounded p-2" />
                <input placeholder="HGT" value={formData.hgt} onChange={e => setFormData({...formData, hgt: e.target.value})} className="bg-gray-700 rounded p-2" />
                <input placeholder="Peso" value={formData.weight} onChange={e => setFormData({...formData, weight: e.target.value})} className="bg-gray-700 rounded p-2" />
                <input placeholder="Altura" value={formData.height} onChange={e => setFormData({...formData, height: e.target.value})} className="bg-gray-700 rounded p-2" />
                <input placeholder="Profissional" value={formData.professional} onChange={e => setFormData({...formData, professional: e.target.value})} className="bg-gray-700 rounded p-2 md:col-span-2" required />
                <button type="submit" className="bg-brand-secondary rounded p-2 font-bold md:col-span-4">{editing ? 'Atualizar' : 'Salvar'}</button>
                {editing && <button type="button" onClick={() => setEditing(null)} className="bg-gray-600 rounded p-2 md:col-span-4">Cancelar Edição</button>}
              </form>
            </div>
            <div className="bg-gray-800/50 p-6 rounded shadow-3d">
              <button onClick={exportCSV} className="mb-4 bg-brand-accent text-black px-4 py-2 rounded flex gap-2"><DownloadIcon /> CSV</button>
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm">
                  <thead><tr className="bg-black/20"><th>Data</th><th>G'mus</th><th>Pressão</th><th>HGT</th><th>Profissional</th><th>Ações</th></tr></thead>
                  <tbody>{indicators.map(i => <tr key={i.id} className="border-b border-gray-700"><td className="p-2">{new Date(i.date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td><td>{i.gmus}</td><td>{i.pressure}</td><td>{i.hgt}</td><td>{i.professional}</td><td className="flex gap-2"><button onClick={() => setEditing(i)}><PencilIcon /></button><button onClick={() => setDeleting(i)} className="text-danger"><TrashIcon /></button></td></tr>)}</tbody>
                </table>
              </div>
            </div>
            {deleting && <ConfirmationModal isOpen={true} onClose={() => setDeleting(null)} onConfirm={async () => { await deleteIndicator(deleting.id); setDeleting(null); }} title="Excluir" message="Confirma?" />}
          </div>
        );
      };

      const App = () => {
        const [page, setPage] = useState('dashboard');
        const [data, setData] = useState({ reports: [], stock: [], indicators: [] });
        const [loading, setLoading] = useState(true);
        const [unlocked, setUnlocked] = useState(false);

        const fetchData = useCallback(async () => {
          setLoading(true);
          try {
            const [r, s, i] = await Promise.all([
              supabaseClient.from('reports').select('*').order('created_at', { ascending: false }),
              supabaseClient.from('stock').select('*').order('test_type', { ascending: true }),
              supabaseClient.from('indicators').select('*').order('date', { ascending: false })
            ]);
            if (r.error || s.error || i.error) throw new Error("Erro DB");
            setData({ reports: r.data, stock: s.data, indicators: i.data });
          } catch (e) { console.error(e); alert("Erro de conexão"); }
          finally { setLoading(false); }
        }, []);

        useEffect(() => { fetchData(); }, [fetchData]);

        const crud = useMemo(() => ({
          addReport: async (d) => { await supabaseClient.from('reports').insert([d]); await fetchData(); },
          updateReport: async (id, d) => { await supabaseClient.from('reports').update(d).eq('id', id); await fetchData(); },
          deleteReport: async (id) => { await supabaseClient.from('reports').delete().eq('id', id); await fetchData(); },
          addStockItem: async (d) => { await supabaseClient.from('stock').insert([d]); await fetchData(); },
          updateStockItem: async (id, d) => { await supabaseClient.from('stock').update(d).eq('id', id); await fetchData(); },
          deleteStockItem: async (id) => { await supabaseClient.from('stock').delete().eq('id', id); await fetchData(); },
          addIndicator: async (d) => { await supabaseClient.from('indicators').insert([d]); await fetchData(); },
          updateIndicator: async (id, d) => { await supabaseClient.from('indicators').update(d).eq('id', id); await fetchData(); },
          deleteIndicator: async (id) => { await supabaseClient.from('indicators').delete().eq('id', id); await fetchData(); },
        }), [fetchData]);

        const renderPage = () => {
          if (loading) return <div className="flex h-full items-center justify-center"><p>Carregando...</p></div>;
          switch (page) {
            case 'reports': return <Reports />;
            case 'inventory': return <Inventory />;
            case 'indicators': return <Indicators />;
            default: return <Dashboard setPage={setPage} />;
          }
        };

        return (
          <AppContext.Provider value={{ ...data, isInventoryUnlocked: unlocked, setIsInventoryUnlocked: setUnlocked, ...crud }}>
            <div className="flex h-screen bg-brand-gray font-sans">
              <Sidebar currentPage={page} setPage={setPage} />
              <main className="flex-1 p-4 sm:p-8 overflow-y-auto">{renderPage()}</main>
            </div>
          </AppContext.Provider>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
