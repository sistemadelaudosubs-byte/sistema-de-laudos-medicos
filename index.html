<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Sistema de Laudos - UBS Santo Afonso</title>
    
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        console.error(error);
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = `
            <div style="color: #39ff14; background: #050505; padding: 20px; font-family: monospace; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <h1 style="font-size: 24px; margin-bottom: 10px; text-transform: uppercase;">[Erro no Sistema]</h1>
              <p style="font-size: 16px; opacity: 0.8;">${message}</p>
              <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #39ff14; color: black; border: none; font-weight: bold; cursor: pointer;">REINICIAR SISTEMA</button>
            </div>
          `;
        }
      };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#39ff14', 'brand-secondary': '#00cc00', 'brand-accent': '#ccff00',
              'brand-dark': '#050505', 'brand-surface': '#111111', 'brand-gray': '#1a1a1a',
              'danger': '#ff0033', 'warning': '#ffcc00',
            },
            boxShadow: { 'neon': '0 0 10px rgba(57, 255, 20, 0.3)' },
            fontFamily: { sans: ['Segoe UI', 'Roboto', 'Arial', 'sans-serif'] },
            aspectRatio: { 'video': '16 / 9' },
            keyframes: { 'pop-in': { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } } },
            animation: { 'pop-in': 'pop-in 0.2s ease-out forwards' }
          },
        },
      };
    </script>
    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #39ff14; }
      body { background-color: #050505; color: #e0e0e0; overflow: hidden; }
      /* Classes para impress√£o exata */
      .print-line { border-bottom: 1px solid black; min-width: 20px; display: inline-block; padding-left: 5px; }
      .print-box { border: 1px solid black; padding: 4px; }
    </style>
  </head>
  <body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useContext, useMemo, createContext } = React;
      const { createRoot } = ReactDOM;
      const { createClient } = supabase;

      // --- Constantes ---
      const TestType = { DENGUE: "DENGUE - NS1", COVID: "COVID-19 - ANT√çGENO", HCG: "HCG - BETA-HCG" };
      const DengueResult = { NEGATIVE: "NEGATIVO", IGG_REAGENT: "IGG REAGENTE", IGM_REAGENT: "IGM REAGENTE", IGG_IGM_REAGENT: "IGG E IGM REAGENTES", POSITIVE: "POSITIVO" };
      const CovidResult = { NEGATIVE: "NEGATIVO", POSITIVE: "POSITIVO" };

      // --- Supabase ---
      const supabaseUrl = 'https://avcpoeouasfeuqsbyuoy.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2Y3BvZW91YXNmZXVxc2J5dW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTkxMjIsImV4cCI6MjA3NzA3NTEyMn0.0eF-yCEBAuHl8B3ORN7VYfJnnEIY0m1bMj8R_FsntNM';
      const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

      const AppContext = createContext({});

      // --- Componentes SVG ---
      const Icon = ({ d }) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d={d} clipRule="evenodd" /></svg>;
      const Icons = {
        Home: () => <Icon d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />,
        Report: () => <Icon d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" />,
        Box: () => <Icon d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />,
        Plus: () => <Icon d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" />,
        Download: () => <Icon d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" />
      };

      // --- Modais Auxiliares ---
      const ModalWrapper = ({ children, title, onClose }) => (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 animate-pop-in p-4 backdrop-blur-sm">
          <div className="bg-brand-surface border border-brand-primary w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-lg shadow-neon">
            <div className="p-4 border-b border-gray-800 flex justify-between items-center">
              <h2 className="text-xl font-bold text-brand-primary">{title}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );

      // --- GERA√á√ÉO DE PDF (REFORMULADA COM BASE NOS MODELOS) ---
      const ReportPDF = ({ report, onDone }) => {
        useEffect(() => {
          const generate = async () => {
            await new Promise(r => setTimeout(r, 800)); // Espera renderizar
            const element = document.getElementById('pdf-content');
            if(!element) return;
            
            try {
              const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true });
              const pdf = new window.jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
              const imgData = canvas.toDataURL('image/png');
              const pdfWidth = 210; 
              const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
              pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
              
              const safeName = (report.patient_name || 'paciente').normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
              pdf.save(`laudo_${safeName}.pdf`);
              onDone();
            } catch (err) {
              console.error(err);
              alert("Erro ao gerar PDF");
              onDone();
            }
          };
          generate();
        }, [report]);

        // Helpers de Layout do PDF
        const Line = ({ label, value, full = false }) => (
          <div className={`flex items-baseline mb-1 ${full ? 'w-full' : ''}`} style={{fontSize: '11pt'}}>
            <span className="font-bold mr-1 whitespace-nowrap">{label}</span>
            <span className="border-b border-black flex-1 pl-2">{value || ''}</span>
          </div>
        );

        const Header = ({ title, sub }) => (
          <div className="mb-6 flex justify-between items-start border-b-2 border-black pb-2">
            <div className="flex gap-2 items-center">
              <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Bras%C3%A3o_de_Novo_Hamburgo.svg/1200px-Bras%C3%A3o_de_Novo_Hamburgo.svg.png" className="h-16 w-auto grayscale contrast-200" alt="Bras√£o" />
              <div className="text-xs font-bold leading-tight">
                <p>Munic√≠pio de Novo Hamburgo</p>
                <p>Estado do Rio Grande do Sul</p>
                <p>Secretaria Municipal de Sa√∫de</p>
              </div>
            </div>
            <div className="text-right">
              <h1 className="text-xl font-bold uppercase">{title}</h1>
              {sub && <h2 className="text-sm font-normal">{sub}</h2>}
            </div>
          </div>
        );

        // --- MODELO 1: DENGUE ---
        const DengueLayout = () => (
          <div className="p-8 bg-white text-black font-sans min-h-[297mm] relative">
            <Header title="TESTE DE ANT√çGENO PARA DENGUE - NS1" sub="(Vida Rapid Test - Vida Biotecnologia)" />
            
            <div className="space-y-2 mb-6">
              <Line label="Nome do usu√°rio:" value={report.patient_name} full />
              <Line label="Identidade/CPF:" value={report.patient_id} full />
              <div className="flex gap-4">
                <div className="w-2/3"><Line label="Data de Nascimento:" value={new Date(report.birth_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} /></div>
                <div className="w-1/3"><Line label="Sexo:" value={report.sex} /></div>
              </div>
              <Line label="Unidade de realiza√ß√£o do exame:" value={report.execution_unit} full />
              <Line label="Data do in√≠cio dos sintomas:" value={new Date(report.symptom_start_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} full />
              <Line label="Data da coleta da amostra:" value={new Date(report.sample_collection_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} full />
            </div>

            <div className="border-2 border-black mb-6">
              <div className="p-2 border-b border-black"><strong>Amostra:</strong> pun√ß√£o digital</div>
              <div className="p-2 border-b border-black"><strong>Teste:</strong> Vida Rapid Test - Dengue NS1 (Vida Biotecnologia)</div>
              <div className="flex border-b border-black">
                <div className="w-1/2 p-2 border-r border-black"><strong>Lote:</strong> {report.lote}</div>
                <div className="w-1/2 p-2"><strong>Validade:</strong> {new Date(report.validade).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</div>
              </div>
              <div className="p-2 border-b border-black"><strong>M√©todo:</strong> Imunocromatografia</div>
              <div className="p-2 bg-gray-100">
                <p className="font-bold text-lg mb-2">RESULTADO DO TESTE:</p>
                <p className="text-3xl font-bold uppercase text-center mb-2">{report.result}</p>
              </div>
            </div>

            <div className="text-xs text-justify mb-8 leading-tight">
              <p className="font-bold mb-2">‚á® Em caso de resultado NEGATIVO ou INCONCLUSIVO: REALIZAR NOVA COLETA A PARTIR DO 7¬∫ DIA DO IN√çCIO DOS SINTOMAS, para o exame de an√°lise de anticorpos IgM.</p>
              <p className="mb-2">Dirigir-se ao Laborat√≥rio P√∫blico Municipal de Novo Hamburgo, localizado na Rua Pedro Adams Filho, n.¬∫ 6520, Bairro Oper√°rio, junto ao Hospital Municipal, das 7 √†s 18h, de segunda √† sexta-feira. OBS: Essa coleta deve ser realizada, NO M√ÅXIMO, at√© o 30¬∫ dia de sintomas.</p>
              <p><strong>Nota:</strong> O resultado deste teste laboratorial deve ser sempre considerado no contexto da cl√≠nica e dos dados epidemiol√≥gicos no estabelecimento do diagn√≥stico. Adverte-se que os testes r√°pidos (pun√ß√£o digital) dever√£o ser utilizados apenas como triagem.</p>
            </div>

            <div className="mt-auto">
              <Line label="T√©cnico Executor:" value={report.technician_name} full />
              <div className="flex gap-4 mt-4">
                <div className="w-1/3"><Line label="Data:" value={new Date(report.report_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} /></div>
                <div className="w-2/3"><Line label="Assinatura e carimbo:" value="" /></div>
              </div>
            </div>
          </div>
        );

        // --- MODELO 2: COVID ---
        const CovidLayout = () => (
          <div className="p-8 bg-white text-black font-sans min-h-[297mm] relative border-4 border-double border-black m-4">
            <div className="text-center border-b-2 border-black pb-2 mb-4">
              <h1 className="text-2xl font-bold">LAUDO</h1>
              <h2 className="text-xl font-bold bg-gray-200 mt-2 py-1 border-t border-b border-black">TESTE R√ÅPIDO DE ANT√çGENO COVID-19</h2>
            </div>

            <div className="space-y-2 mb-4 text-sm font-bold">
              <div className="flex justify-between">
                <div className="w-2/3 flex"><span className="mr-2">Nome do paciente:</span><span className="flex-1 border-b border-dotted border-black">{report.patient_name}</span></div>
                <div className="w-1/3 flex"><span className="mr-2">Cidade:</span><span className="flex-1 border-b border-dotted border-black">{report.city}</span></div>
              </div>
              <div className="flex justify-between">
                <div className="w-1/3 flex"><span className="mr-2">Sexo:</span><span className="flex-1 border-b border-dotted border-black">{report.sex}</span></div>
                <div className="w-2/3 flex"><span className="mr-2">Data de nascimento:</span><span className="flex-1 border-b border-dotted border-black">{new Date(report.birth_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</span></div>
              </div>
            </div>

            <div className="border-2 border-black p-4 mb-4 text-sm">
              <p className="font-bold underline mb-2">TESTE</p>
              <p><strong>Fabricante:</strong> {report.manufacturer || 'N√£o informado'}</p>
              <p><strong>Lote:</strong> {report.lote}</p>
              <p><strong>M√©todo:</strong> Imunocromatografia</p>
              <div className="flex gap-4 mt-2">
                <strong>Amostra:</strong>
                <span>( {report.sample_type === 'swab nasofar√≠ngeo' ? 'X' : ' '} ) swab nasofar√≠ngeo</span>
                <span>( {report.sample_type === 'swab nasal' ? 'X' : ' '} ) swab nasal</span>
              </div>
            </div>

            <div className="mb-6">
              <p className="font-bold underline mb-2">RESULTADO DO TESTE</p>
              <div className="ml-4 space-y-2 text-lg">
                <p>( {report.result === 'POSITIVO' ? 'X' : ' '} ) Positivo</p>
                <p>( {report.result === 'NEGATIVO' ? 'X' : ' '} ) Negativo</p>
              </div>
            </div>

            <div className="text-xs mb-8">
              <p className="font-bold underline mb-2">Observa√ß√µes:</p>
              <ol className="list-decimal list-inside space-y-1">
                <li>O teste r√°pido √© utilizado como aux√≠lio diagn√≥stico para a COVID-19.</li>
                <li>Mediante avalia√ß√£o cl√≠nica e epidemiol√≥gica, testes de ant√≠geno com resultado positivo podem ser considerados confirmat√≥rios.</li>
                <li>Dada a sensibilidade esperada, um resultado negativo n√£o exclui uma poss√≠vel infec√ß√£o.</li>
              </ol>
            </div>

            <div className="mt-auto flex justify-between items-end">
              <div className="text-center">
                <p className="border-t border-black px-8 pt-1">Respons√°vel T√©cnico</p>
                <p className="text-xs">(carimbo e assinatura) - {report.technician_name}</p>
              </div>
              <div className="flex items-baseline">
                <span className="font-bold mr-2">Data:</span>
                <span className="border-b border-black min-w-[100px] text-center">{new Date(report.report_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</span>
              </div>
            </div>
          </div>
        );

        // --- MODELO 3: HCG ---
        const HcgLayout = () => (
          <div className="p-10 bg-white text-black font-sans min-h-[297mm] relative">
            <div className="flex justify-between items-center mb-8 border-b-2 border-black pb-4">
               <div className="flex gap-2 items-center">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Bras%C3%A3o_de_Novo_Hamburgo.svg/1200px-Bras%C3%A3o_de_Novo_Hamburgo.svg.png" className="h-12 w-auto grayscale contrast-200" />
                  <div className="text-[8pt] font-bold leading-tight">
                    <p>Prefeitura Municipal de Novo Hamburgo</p>
                    <p>Estado do Rio Grande do Sul</p>
                    <p>Secretaria Municipal de Sa√∫de</p>
                  </div>
                </div>
                <div className="text-2xl font-bold tracking-widest border-l-2 border-black pl-4">SA√öDE</div>
            </div>

            <div className="space-y-4 mb-8">
              <Line label="Nome do usu√°rio:" value={report.patient_name} full />
              <div className="flex gap-4">
                <div className="w-1/2"><Line label="Prontu√°rio:" value={report.prontuario} /></div>
                <div className="w-1/2"><Line label="Identidade:" value={report.patient_id} /></div>
              </div>
              <div className="flex gap-4">
                <div className="w-1/2"><Line label="Data de Nascimento:" value={new Date(report.birth_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} /></div>
                <div className="w-1/2"><Line label="Sexo:" value="FEMININO" /></div>
              </div>
              <Line label="Unidade de realiza√ß√£o do exame:" value={report.execution_unit} full />
              <Line label="Data da coleta da amostra:" value={new Date(report.sample_collection_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})} full />
            </div>

            <h1 className="text-2xl font-bold text-center uppercase mb-8">TESTE R√ÅPIDO PARA DETEC√á√ÉO DE HCG</h1>

            <div className="border border-black mb-6">
              <div className="p-2 border-b border-black"><strong>Amostra:</strong> urina</div>
              <div className="flex border-b border-black p-2">
                <div className="w-1/3"><strong>Teste:</strong> Teste R√°pido HCG</div>
                <div className="w-1/3"><strong>Lote:</strong> {report.lote}</div>
                <div className="w-1/3"><strong>Validade:</strong> {new Date(report.validade).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</div>
              </div>
              <div className="p-2 border-b border-black"><strong>M√©todo:</strong> Imunocromatografia</div>
              <div className="p-4 bg-gray-100 text-center">
                <strong className="text-xl mr-4">RESULTADO DO TESTE:</strong>
                <span className="text-3xl font-bold border-b-2 border-black px-4">{report.result_value}</span>
              </div>
            </div>

            <div className="text-xs text-justify mb-12">
              <p className="font-bold mb-1">Valor de refer√™ncia: NEGATIVO: &lt; 25mUI/mL - POSITIVO: &gt; 25mUI/mL</p>
              <p>A produ√ß√£o do HCG se inicia nos primeiros dias ap√≥s a concep√ß√£o e √© bastante vari√°vel entre os indiv√≠duos. O valor negativo associado ao atraso menstrual de poucos dias n√£o exclui gesta√ß√£o. Nestes casos, a crit√©rio cl√≠nico, sugerimos refazer o exame ap√≥s sete dias.</p>
            </div>

            <div className="mt-auto flex justify-between items-end pb-8">
              <div className="w-1/3">
                <p className="font-bold mb-8">Respons√°vel T√©cnico:</p>
                <p className="border-t border-black pt-1">{report.technician_name}</p>
              </div>
              <div className="w-1/3 text-right">
                <p className="border-t border-black pt-1 text-center">Assinatura e carimbo</p>
              </div>
            </div>
            
            <p className="text-[7pt] text-center border-t border-gray-300 pt-2">Este laudo possui car√°ter meramente informativo e ilustrativo.</p>
          </div>
        );

        return (
          <div className="fixed inset-0 bg-black z-[9999] flex flex-col items-center justify-center">
            <div className="text-brand-primary text-xl font-bold animate-pulse mb-4">Gerando Documento...</div>
            <div className="bg-white overflow-hidden" style={{ width: '210mm', minHeight: '297mm' }}>
              <div id="pdf-content">
                {report.test_type === TestType.DENGUE && <DengueLayout />}
                {report.test_type === TestType.COVID && <CovidLayout />}
                {report.test_type === TestType.HCG && <HcgLayout />}
              </div>
            </div>
          </div>
        );
      };

      // --- FORMUL√ÅRIO ---
      const ReportForm = ({ onClose, onSave, initialData, isEdit }) => {
        const { stock } = useContext(AppContext);
        const [form, setForm] = useState(initialData || {});

        const handleChange = (e) => {
          const { name, value } = e.target;
          setForm(prev => ({ ...prev, [name]: name === 'result' ? value : value.toUpperCase() }));
        };

        const handleTypeChange = (e) => {
          const type = e.target.value;
          setForm(prev => ({
            ...prev,
            test_type: type,
            result: type === TestType.COVID ? 'NEGATIVO' : 'NEGATIVO', // Default
            sample_type: type === TestType.COVID ? 'swab nasal' : (type === TestType.HCG ? 'urina' : 'pun√ß√£o digital')
          }));
        };

        return (
          <ModalWrapper title={isEdit ? "Editar Laudo" : "Novo Laudo"} onClose={onClose}>
            <form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="space-y-4 text-sm">
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2">
                  <label className="block text-brand-primary mb-1">Tipo de Exame</label>
                  <select name="test_type" value={form.test_type} onChange={handleTypeChange} className="w-full bg-brand-gray border border-gray-600 rounded p-2 text-white">
                    {Object.values(TestType).map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>

                {!isEdit && (
                  <div className="col-span-2 bg-gray-900 p-3 rounded border border-gray-700">
                    <label className="block text-warning mb-1">Selecione o Lote do Estoque</label>
                    <select name="lote" required value={form.lote || ''} onChange={(e) => {
                        const item = stock.find(i => i.lote === e.target.value && i.test_type === form.test_type);
                        if(item) setForm(prev => ({ ...prev, lote: item.lote, validade: item.validade }));
                    }} className="w-full bg-black border border-warning rounded p-2 text-white">
                      <option value="">Selecione...</option>
                      {stock.filter(i => i.test_type === form.test_type && i.quantity > 0).map(i => (
                        <option key={i.id} value={i.lote}>{i.lote} (Val: {new Date(i.validade).toLocaleDateString('pt-BR', {timeZone:'UTC'})}) - Qtd: {i.quantity}</option>
                      ))}
                    </select>
                  </div>
                )}

                <div className="col-span-2"><label>Nome Paciente</label><input required name="patient_name" value={form.patient_name || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                
                {form.test_type === TestType.HCG ? (
                  <>
                    <div><label>Prontu√°rio</label><input name="prontuario" value={form.prontuario || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                    <div><label>Identidade</label><input name="patient_id" value={form.patient_id || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                  </>
                ) : (
                  <div><label>CPF/RG</label><input name="patient_id" value={form.patient_id || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                )}

                <div><label>Data Nascimento</label><input required type="date" name="birth_date" value={form.birth_date || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                
                <div><label>Sexo</label><select name="sex" value={form.sex} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select></div>
                <div><label>Data Coleta</label><input required type="date" name="sample_collection_date" value={form.sample_collection_date || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                <div><label>Unidade</label><input required name="execution_unit" value={form.execution_unit || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>
                <div><label>T√©cnico</label><input required name="technician_name" value={form.technician_name || ''} onChange={handleChange} className="w-full bg-brand-gray border-gray-600 rounded p-2" /></div>

                {/* Campos Espec√≠ficos */}
                {form.test_type === TestType.DENGUE && (
                  <div className="col-span-2 grid grid-cols-2 gap-4 bg-gray-800/50 p-2 rounded">
                    <div><label>In√≠cio Sintomas</label><input type="date" name="symptom_start_date" value={form.symptom_start_date || ''} onChange={handleChange} className="w-full bg-brand-gray rounded p-2" /></div>
                    <div><label className="text-brand-primary">Resultado</label><select name="result" value={form.result} onChange={handleChange} className="w-full bg-brand-gray border-brand-primary rounded p-2">{Object.values(DengueResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                  </div>
                )}

                {form.test_type === TestType.COVID && (
                  <div className="col-span-2 grid grid-cols-2 gap-4 bg-gray-800/50 p-2 rounded">
                    <div><label>Cidade</label><input name="city" value={form.city || ''} onChange={handleChange} className="w-full bg-brand-gray rounded p-2" /></div>
                    <div><label>Fabricante</label><input name="manufacturer" value={form.manufacturer || ''} onChange={handleChange} className="w-full bg-brand-gray rounded p-2" /></div>
                    <div><label>Tipo Amostra</label><select name="sample_type" value={form.sample_type} onChange={handleChange} className="w-full bg-brand-gray rounded p-2"><option value="swab nasal">Swab Nasal</option><option value="swab nasofar√≠ngeo">Swab Nasofar√≠ngeo</option></select></div>
                    <div><label className="text-brand-primary">Resultado</label><select name="result" value={form.result} onChange={handleChange} className="w-full bg-brand-gray border-brand-primary rounded p-2">{Object.values(CovidResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                  </div>
                )}

                {form.test_type === TestType.HCG && (
                  <div className="col-span-2 bg-gray-800/50 p-2 rounded">
                    <label className="text-brand-primary block mb-1">Resultado (Valor de Refer√™ncia)</label>
                    <select name="result_value" value={form.result_value || ''} onChange={handleChange} className="w-full bg-brand-gray border-brand-primary rounded p-2">
                      <option value="">Selecione...</option>
                      <option value="POSITIVO">POSITIVO</option>
                      <option value="NEGATIVO">NEGATIVO</option>
                    </select>
                  </div>
                )}
              </div>
              <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">Cancelar</button>
                <button type="submit" className="px-4 py-2 bg-brand-secondary text-black font-bold rounded shadow-neon hover:shadow-none transition-all">Salvar Laudo</button>
              </div>
            </form>
          </ModalWrapper>
        );
      };

      // --- TELAS ---
      const Dashboard = ({ setPage, onNewReport }) => {
        const { reports, stock } = useContext(AppContext);
        const lowStock = stock.filter(i => i.quantity <= 5);
        return (
          <div className="p-6 space-y-6 animate-pop-in">
            <header className="flex justify-between items-center mb-8">
              <h1 className="text-4xl font-bold text-brand-primary tracking-widest">DASHBOARD</h1>
              <button onClick={onNewReport} className="bg-brand-primary text-black px-6 py-3 rounded font-bold shadow-neon hover:scale-105 transition-transform flex gap-2 items-center"><Icons.Plus /> NOVO LAUDO</button>
            </header>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-brand-surface p-6 rounded border border-gray-800 flex items-center gap-4">
                <div className="p-3 bg-blue-900/50 text-blue-400 rounded"><Icons.Report /></div>
                <div><p className="text-gray-400">Laudos Emitidos</p><p className="text-3xl font-bold">{reports.length}</p></div>
              </div>
              <div className="bg-brand-surface p-6 rounded border border-gray-800 flex items-center gap-4">
                <div className="p-3 bg-green-900/50 text-brand-primary rounded"><Icons.Box /></div>
                <div><p className="text-gray-400">Estoque Total</p><p className="text-3xl font-bold">{stock.reduce((a,b)=>a+b.quantity,0)}</p></div>
              </div>
              <div className="bg-brand-surface p-6 rounded border border-gray-800 flex items-center gap-4">
                <div className="p-3 bg-red-900/50 text-danger rounded"><Icons.Home /></div> {/* Alert Icon placeholder */}
                <div><p className="text-gray-400">Estoque Cr√≠tico</p><p className="text-3xl font-bold">{lowStock.length}</p></div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="bg-brand-surface p-6 rounded border border-gray-800">
                <h3 className="text-brand-secondary font-bold mb-4">‚ö†Ô∏è Alerta de Estoque</h3>
                <ul className="space-y-2">
                  {lowStock.map(i => <li key={i.id} className="flex justify-between text-sm border-b border-gray-800 pb-1"><span>{i.test_type.split('-')[0]}</span><span className="text-danger font-bold">{i.quantity} un</span></li>)}
                </ul>
              </div>
              <div className="lg:col-span-2 bg-brand-surface p-6 rounded border border-gray-800">
                <h3 className="text-brand-secondary font-bold mb-4">üìã √öltimos Laudos</h3>
                <table className="w-full text-left text-sm">
                  <thead className="text-gray-500 border-b border-gray-700"><tr><th className="pb-2">Paciente</th><th>Exame</th><th>Data</th></tr></thead>
                  <tbody>
                    {reports.slice(0,5).map(r => (
                      <tr key={r.id} className="border-b border-gray-800 text-gray-300">
                        <td className="py-2">{r.patient_name}</td>
                        <td className="text-brand-primary">{r.test_type.split('-')[0]}</td>
                        <td>{new Date(r.report_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div className="w-full aspect-video rounded border border-gray-800 overflow-hidden shadow-neon">
               <img src="https://www.tjpb.jus.br/sites/default/files/media/2022/12/WhatsApp_Image_2022-12-01_at_10.37.10.jpeg" className="w-full h-full object-cover opacity-80" />
            </div>
          </div>
        );
      };

      const ReportsList = ({ autoOpen }) => {
        const { reports } = useContext(AppContext);
        const [search, setSearch] = useState('');
        const [showModal, setShowModal] = useState(false);
        const [pdfReport, setPdfReport] = useState(null);
        
        // Handle Auto Open from Dashboard
        useEffect(() => { if(autoOpen) setShowModal(true); }, [autoOpen]);

        const filtered = reports.filter(r => r.patient_name.toLowerCase().includes(search.toLowerCase()));

        return (
          <div className="p-6 h-full flex flex-col animate-pop-in">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-4xl font-bold text-brand-primary">LAUDOS</h1>
              <input placeholder="Buscar paciente..." className="bg-brand-surface border border-gray-700 p-2 rounded w-64 text-white" value={search} onChange={e => setSearch(e.target.value)} />
            </div>
            
            <div className="flex-1 bg-brand-surface border border-gray-800 rounded overflow-hidden flex flex-col">
              <div className="overflow-y-auto flex-1">
                <table className="w-full text-left">
                  <thead className="bg-gray-900 text-brand-secondary sticky top-0">
                    <tr><th className="p-4">Paciente</th><th>Exame</th><th>Data</th><th>A√ß√µes</th></tr>
                  </thead>
                  <tbody>
                    {filtered.map(r => (
                      <tr key={r.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                        <td className="p-4 font-bold">{r.patient_name}</td>
                        <td>{r.test_type}</td>
                        <td>{new Date(r.report_date).toLocaleDateString('pt-BR', {timeZone:'UTC'})}</td>
                        <td className="p-4">
                          <button onClick={() => setPdfReport(r)} className="text-brand-primary hover:text-white mr-4" title="Baixar PDF"><Icons.Download /></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {showModal && <ReportForm onClose={() => setShowModal(false)} onSave={async (data) => { /* L√≥gica no App */ }} />}
            {pdfReport && <ReportPDF report={pdfReport} onDone={() => setPdfReport(null)} />}
          </div>
        );
      };

      // --- APP PRINCIPAL ---
      const App = () => {
        const [page, setPage] = useState('dashboard');
        const [data, setData] = useState({ reports: [], stock: [] });
        const [loading, setLoading] = useState(true);
        const [triggerReportModal, setTriggerReportModal] = useState(false);

        const fetchData = useCallback(async () => {
          setLoading(true);
          const [r, s] = await Promise.all([
            supabaseClient.from('reports').select('*').order('created_at', {ascending:false}),
            supabaseClient.from('stock').select('*').order('test_type', {ascending:true})
          ]);
          setData({ reports: r.data || [], stock: s.data || [] });
          setLoading(false);
        }, []);

        useEffect(() => { fetchData(); }, [fetchData]);

        const handleSaveReport = async (formData) => {
          try {
            // 1. Salvar Laudo
            const { error } = await supabaseClient.from('reports').insert([formData]);
            if (error) throw error;

            // 2. Baixar Estoque
            const stockItem = data.stock.find(i => i.lote === formData.lote && i.test_type === formData.test_type);
            if (stockItem && stockItem.quantity > 0) {
              await supabaseClient.from('stock').update({ quantity: stockItem.quantity - 1 }).eq('id', stockItem.id);
            }

            await fetchData();
            setTriggerReportModal(false);
          } catch (e) {
            console.error(e);
            alert("Erro ao salvar laudo: " + e.message);
          }
        };

        const MainContent = () => {
          if (page === 'dashboard') return <Dashboard setPage={setPage} onNewReport={() => setTriggerReportModal(true)} />;
          if (page === 'reports') return <ReportsList autoOpen={false} />;
          return <div className="p-10 text-center">Em constru√ß√£o...</div>;
        };

        if (loading) return <div className="h-screen flex items-center justify-center text-brand-primary animate-pulse font-bold text-2xl">CARREGANDO SISTEMA...</div>;

        return (
          <AppContext.Provider value={{ ...data }}>
            <div className="flex h-screen bg-brand-dark text-white font-sans overflow-hidden">
              <nav className="w-20 lg:w-64 bg-black border-r border-gray-800 flex flex-col items-center lg:items-start py-6">
                <div className="text-brand-primary font-bold text-2xl px-6 mb-10 hidden lg:block">UBS <span className="text-white">SYS</span></div>
                <div className="w-full space-y-2 px-2">
                  <button onClick={() => setPage('dashboard')} className={`w-full p-3 rounded flex items-center gap-4 ${page==='dashboard' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white hover:bg-gray-900'}`}><Icons.Home /><span className="hidden lg:block">Dashboard</span></button>
                  <button onClick={() => setPage('reports')} className={`w-full p-3 rounded flex items-center gap-4 ${page==='reports' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white hover:bg-gray-900'}`}><Icons.Report /><span className="hidden lg:block">Laudos</span></button>
                </div>
              </nav>
              <main className="flex-1 relative overflow-hidden">
                <MainContent />
                {triggerReportModal && <ReportForm onClose={() => setTriggerReportModal(false)} onSave={handleSaveReport} />}
              </main>
            </div>
          </AppContext.Provider>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
