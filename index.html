<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Sistema de Laudos - UBS Santo Afonso</title>
    
    <script>
      window.onerror = function(msg, url, line, col, error) {
        if (msg.includes('ResizeObserver')) return false;
        const root = document.getElementById('root');
        if (root && !root.innerHTML.includes('SISTEMA ONLINE')) {
           root.innerHTML = '<div style="color:#39ff14;background:#000;height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:monospace;"><h1>SISTEMA ONLINE</h1><p>Reconectando módulos...</p><button onclick="window.location.reload()" style="padding:10px 20px;margin-top:20px;cursor:pointer;font-weight:bold;">ATUALIZAR PÁGINA</button></div>';
        }
      };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#39ff14', 'brand-secondary': '#00cc00', 
              'brand-dark': '#050505', 'brand-surface': '#111111', 
              'brand-gray': '#1a1a1a', 'danger': '#ff0033', 'warning': '#ffcc00',
            },
            boxShadow: { 'neon': '0 0 10px rgba(57, 255, 20, 0.2)' },
            fontFamily: { sans: ['Segoe UI', 'Roboto', 'Arial', 'sans-serif'] },
            aspectRatio: { 'video': '16 / 9' },
            keyframes: { 'pop-in': { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } } },
            animation: { 'pop-in': 'pop-in 0.2s ease-out forwards' }
          },
        },
      };
    </script>
    <style>
      body { background-color: #050505; color: #e0e0e0; overflow: hidden; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #39ff14; }
      .input-neon { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; }
      .input-neon:focus { border-color: #39ff14; box-shadow: 0 0 5px rgba(57,255,20,0.2); }
      .pdf-hide { display: none; } /* Classe auxiliar */
    </style>
  </head>
  <body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback, useContext, useMemo, createContext } = React;
      const { createRoot } = ReactDOM;
      const { createClient } = supabase;

      // --- Constantes ---
      const TestType = { DENGUE: "DENGUE - NS1", COVID: "COVID-19 - ANTÍGENO", HCG: "HCG - BETA-HCG" };
      const DengueResult = { NEGATIVE: "NEGATIVO", IGG_REAGENT: "IGG REAGENTE", IGM_REAGENT: "IGM REAGENTE", IGG_IGM_REAGENT: "IGG E IGM REAGENTES", POSITIVE: "POSITIVO" };
      const CovidResult = { NEGATIVE: "NEGATIVO", POSITIVE: "POSITIVO" };

      // --- Supabase ---
      const supabaseUrl = 'https://avcpoeouasfeuqsbyuoy.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2Y3BvZW91YXNmZXVxc2J5dW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTkxMjIsImV4cCI6MjA3NzA3NTEyMn0.0eF-yCEBAuHl8B3ORN7VYfJnnEIY0m1bMj8R_FsntNM';
      const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

      // Contexto Global com Funções CRUD
      const AppContext = createContext({
        reports: [], stock: [], indicators: [],
        saveReport: () => {}, deleteReport: () => {},
        saveStock: () => {}, deleteStock: () => {},
        saveIndicator: () => {}, deleteIndicator: () => {}
      });

      // --- Ícones ---
      const Icon = ({ d, color }) => <svg xmlns="http://www.w3.org/2000/svg" className={`h-5 w-5 ${color}`} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d={d} clipRule="evenodd" /></svg>;
      const Icons = {
        Home: () => <Icon d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />,
        Report: () => <Icon d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" />,
        Box: () => <Icon d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />,
        Stats: () => <Icon d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />,
        Plus: () => <Icon d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" />,
        Download: () => <Icon d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" />,
        Pencil: () => <Icon d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />,
        Trash: () => <Icon d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" />,
        Alert: () => <Icon d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" />
      };

      // --- Modais ---
      const ModalWrapper = ({ children, title, onClose }) => (
        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 animate-pop-in p-4 backdrop-blur-sm">
          <div className="bg-brand-surface border border-brand-primary w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-lg shadow-neon">
            <div className="p-4 border-b border-gray-800 flex justify-between items-center sticky top-0 bg-brand-surface z-10">
              <h2 className="text-xl font-bold text-brand-primary uppercase">{title}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-white px-2 text-2xl">×</button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );

      const ConfirmationModal = ({ onClose, onConfirm, title, message }) => (
        <ModalWrapper title={title} onClose={onClose}>
          <p className="text-gray-300 mb-6 text-center">{message}</p>
          <div className="flex justify-center gap-4">
            <button onClick={onClose} className="px-6 py-2 bg-gray-700 rounded hover:bg-gray-600 font-bold">CANCELAR</button>
            <button onClick={onConfirm} className="px-6 py-2 bg-danger text-white font-bold rounded shadow-lg hover:bg-red-600">CONFIRMAR</button>
          </div>
        </ModalWrapper>
      );

      // --- PDF ---
      const ReportPDF = ({ report, onDone }) => {
        useEffect(() => {
          const generate = async () => {
            await new Promise(r => setTimeout(r, 1000));
            const element = document.getElementById('pdf-content');
            if(!element) return;
            try {
              const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true });
              const pdf = new window.jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
              const imgData = canvas.toDataURL('image/png');
              pdf.addImage(imgData, 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
              const safeName = (report.patient_name || 'paciente').normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
              pdf.save(`laudo_${safeName}.pdf`);
              onDone();
            } catch (err) { alert("Erro PDF"); onDone(); }
          };
          generate();
        }, [report]);

        const Line = ({ label, value, full }) => (<div className={`flex items-baseline mb-1 ${full?'w-full':''}`} style={{fontSize:'11pt'}}><span className="font-bold mr-1 whitespace-nowrap">{label}</span><span className="border-b border-black flex-1 pl-2">{value||''}</span></div>);
        const Header = ({ title, sub }) => (<div className="mb-6 flex justify-between items-start border-b-2 border-black pb-2"><div className="flex gap-2 items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Bras%C3%A3o_de_Novo_Hamburgo.svg/1200px-Bras%C3%A3o_de_Novo_Hamburgo.svg.png" className="h-16 w-auto grayscale contrast-200" crossOrigin="anonymous"/><div className="text-xs font-bold leading-tight uppercase"><p>Município de Novo Hamburgo</p><p>Estado do Rio Grande do Sul</p><p>Secretaria de Saúde</p></div></div><div className="text-right"><h1 className="text-xl font-bold uppercase">{title}</h1>{sub && <h2 className="text-sm font-normal">{sub}</h2>}</div></div>);
        const Footer = ({ r }) => (<div className="mt-auto pt-12 text-sm flex justify-between items-end"><div className="text-center"><div className="w-80 border-t-2 border-black mb-1"></div><p className="font-bold uppercase">{r.technician_name}</p><p>Técnico Responsável</p></div><div><p className="font-bold">Data do Laudo: {new Date(r.report_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</p></div></div>);

        return (
          <div className="fixed inset-0 bg-black z-[9999] flex flex-col items-center justify-center">
            <div className="text-brand-primary text-xl font-bold animate-pulse mb-4">Gerando PDF...</div>
            <div className="bg-white overflow-hidden shadow-2xl" style={{ width:'210mm', minHeight:'297mm' }}>
              <div id="pdf-content" className="p-10 text-black font-sans min-h-[297mm] flex flex-col relative bg-white">
                {report.test_type === TestType.DENGUE && (
                  <>
                    <Header title="TESTE DE ANTÍGENO PARA DENGUE - NS1" sub="(Vida Rapid Test - Vida Biotecnologia)" />
                    <div className="space-y-2 mb-6"><Line label="Nome do usuário:" value={report.patient_name} full /><Line label="Identidade/CPF:" value={report.patient_id} full /><div className="flex gap-4"><div className="w-2/3"><Line label="Data de Nascimento:" value={new Date(report.birth_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})}/></div><div className="w-1/3"><Line label="Sexo:" value={report.sex}/></div></div><Line label="Unidade de realização do exame:" value={report.execution_unit} full /><Line label="Data do início dos sintomas:" value={new Date(report.symptom_start_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})} full /><Line label="Data da coleta da amostra:" value={new Date(report.sample_collection_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})} full /></div>
                    <div className="border-2 border-black mb-6"><div className="p-2 border-b border-black"><strong>Amostra:</strong> punção digital</div><div className="p-2 border-b border-black"><strong>Teste:</strong> Vida Rapid Test - Dengue NS1 (Vida Biotecnologia)</div><div className="flex border-b border-black"><div className="w-1/2 p-2 border-r border-black"><strong>Lote:</strong> {report.lote}</div><div className="w-1/2 p-2"><strong>Validade:</strong> {new Date(report.validade).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</div></div><div className="p-2 border-b border-black"><strong>Método:</strong> Imunocromatografia</div><div className="p-2 bg-gray-100"><p className="font-bold text-lg mb-2">RESULTADO DO TESTE:</p><p className="text-3xl font-bold uppercase text-center mb-2">{report.result}</p></div></div>
                    <div className="text-xs text-justify mb-8 leading-tight"><p className="font-bold mb-2">⇨ Em caso de resultado NEGATIVO ou INCONCLUSIVO: REALIZAR NOVA COLETA A PARTIR DO 7º DIA DO INÍCIO DOS SINTOMAS...</p></div><Footer r={report} />
                  </>
                )}
                {report.test_type === TestType.COVID && (
                  <div className="border-4 border-double border-black p-6 h-full flex-1 flex flex-col">
                    <div className="text-center border-b-2 border-black pb-2 mb-4"><h1 className="text-2xl font-bold">LAUDO</h1><h2 className="text-xl font-bold bg-gray-200 mt-2 py-1 border-t border-b border-black">TESTE RÁPIDO DE ANTÍGENO COVID-19</h2></div>
                    <div className="space-y-2 mb-4 text-sm font-bold"><div className="flex justify-between"><div className="w-2/3 flex"><span className="mr-2">Nome:</span><span className="flex-1 border-b border-dotted border-black">{report.patient_name}</span></div><div className="w-1/3 flex"><span className="mr-2">Cidade:</span><span className="flex-1 border-b border-dotted border-black">{report.city}</span></div></div><div className="flex justify-between"><div className="w-1/3 flex"><span className="mr-2">Sexo:</span><span className="flex-1 border-b border-dotted border-black">{report.sex}</span></div><div className="w-2/3 flex"><span className="mr-2">Nascimento:</span><span className="flex-1 border-b border-dotted border-black">{new Date(report.birth_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</span></div></div></div>
                    <div className="border-2 border-black p-4 mb-4 text-sm"><p className="font-bold underline mb-2">TESTE</p><p><strong>Fabricante:</strong> {report.manufacturer}</p><p><strong>Lote:</strong> {report.lote}</p><p><strong>Método:</strong> Imunocromatografia</p><div className="flex gap-4 mt-2"><strong>Amostra:</strong><span>( {report.sample_type==='swab nasofaríngeo'?'X':' '} ) nasofaríngeo</span><span>( {report.sample_type==='swab nasal'?'X':' '} ) nasal</span></div></div>
                    <div className="mb-6"><p className="font-bold underline mb-2">RESULTADO</p><div className="ml-4 space-y-2 text-lg"><p>( {report.result==='POSITIVO'?'X':' '} ) Positivo</p><p>( {report.result==='NEGATIVO'?'X':' '} ) Negativo</p></div></div>
                    <div className="text-xs mb-8 flex-1"><p className="font-bold underline mb-2">Observações:</p><ol className="list-decimal list-inside space-y-1"><li>Auxílio diagnóstico.</li><li>Positivo confirmatório.</li><li>Negativo não exclui.</li></ol></div>
                    <div className="mt-auto flex justify-between items-end"><div className="text-center"><p className="border-t border-black px-8 pt-1">Responsável Técnico</p><p className="text-xs">{report.technician_name}</p></div><div className="flex items-baseline"><span className="font-bold mr-2">Data:</span><span className="border-b border-black min-w-[100px] text-center">{new Date(report.report_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</span></div></div>
                  </div>
                )}
                {report.test_type === TestType.HCG && (
                  <>
                    <div className="flex justify-between items-center mb-8 border-b-2 border-black pb-4"><div className="flex gap-2 items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Bras%C3%A3o_de_Novo_Hamburgo.svg/1200px-Bras%C3%A3o_de_Novo_Hamburgo.svg.png" className="h-12 w-auto grayscale contrast-200" crossOrigin="anonymous"/><div className="text-[8pt] font-bold leading-tight"><p>Prefeitura Municipal de Novo Hamburgo</p><p>Secretaria Municipal de Saúde</p></div></div><div className="text-2xl font-bold tracking-widest border-l-2 border-black pl-4">SAÚDE</div></div>
                    <div className="space-y-4 mb-8"><Line label="Nome do usuário:" value={report.patient_name} full /><div className="flex gap-4"><div className="w-1/2"><Line label="Prontuário:" value={report.prontuario} /></div><div className="w-1/2"><Line label="Identidade:" value={report.patient_id} /></div></div><div className="flex gap-4"><div className="w-1/2"><Line label="Data de Nascimento:" value={new Date(report.birth_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})} /></div><div className="w-1/2"><Line label="Sexo:" value="FEMININO" /></div></div><Line label="Unidade de realização do exame:" value={report.execution_unit} full /><Line label="Data da coleta da amostra:" value={new Date(report.sample_collection_date).toLocaleDateString('pt-BR',{timeZone:'UTC'})} full /></div>
                    <h1 className="text-2xl font-bold text-center uppercase mb-8">TESTE RÁPIDO PARA DETECÇÃO DE HCG</h1>
                    <div className="border border-black mb-6"><div className="p-2 border-b border-black"><strong>Amostra:</strong> urina</div><div className="flex border-b border-black p-2"><div className="w-1/3"><strong>Teste:</strong> HCG</div><div className="w-1/3"><strong>Lote:</strong> {report.lote}</div><div className="w-1/3"><strong>Validade:</strong> {new Date(report.validade).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</div></div><div className="p-2 border-b border-black"><strong>Método:</strong> Imunocromatografia</div><div className="p-4 bg-gray-100 text-center"><strong className="text-xl mr-4">RESULTADO DO TESTE:</strong><span className="text-3xl font-bold border-b-2 border-black px-4">{report.result_value}</span></div></div>
                    <div className="text-xs text-justify mb-12"><p className="font-bold mb-1">Valor de referência: NEGATIVO: &lt; 25mUI/mL - POSITIVO: &gt; 25mUI/mL</p></div><Footer r={report} />
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      // --- Componentes de Tela ---
      const ReportForm = ({ onClose, initialData }) => {
        const { stock, saveReport } = useContext(AppContext);
        const [form, setForm] = useState(initialData || {});
        
        useEffect(() => {
            if (!initialData) {
                const today = new Date().toISOString().split('T')[0];
                setForm({ test_type: TestType.DENGUE, patient_name: '', patient_id: '', birth_date: '', sex: 'Feminino', execution_unit: '', sample_collection_date: today, technician_name: '', report_date: today, lote: '', validade: '', symptom_start_date: today, sample_type: 'punção digital', result: 'NEGATIVO', city: '', manufacturer: '', prontuario: '', result_value: '' });
            }
        }, [initialData]);

        const handleChange = (e) => setForm(p => ({ ...p, [e.target.name]: (e.target.name === 'result' || e.target.name === 'test_type' || e.target.name === 'result_value') ? e.target.value : e.target.value.toUpperCase() }));
        const handleType = (e) => { const t = e.target.value; let defs = { test_type: t, result: 'NEGATIVO', result_value: '' }; if (t === TestType.COVID) defs.sample_type = 'swab nasal'; if (t === TestType.HCG) defs.sample_type = 'urina'; setForm(p => ({ ...p, ...defs })); };

        return (
          <ModalWrapper title={initialData ? "Editar" : "Novo Laudo"} onClose={onClose}>
            <form onSubmit={e => { e.preventDefault(); saveReport(form); onClose(); }} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2"><label className="text-brand-primary text-xs">Exame</label><select name="test_type" value={form.test_type} onChange={handleType} className="input-neon">{Object.values(TestType).map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                {!initialData && <div className="col-span-2 bg-gray-900 p-2 rounded border border-warning/50"><label className="text-warning text-xs">Lote (Baixa Estoque)</label><select name="lote" value={form.lote} onChange={e => { const i = (stock || []).find(x => x.lote === e.target.value && x.test_type === form.test_type); if (i) setForm(p => ({ ...p, lote: i.lote, validade: i.validade })) }} className="input-neon bg-black border-warning"><option value="">Selecione...</option>{(stock || []).filter(i => i.test_type === form.test_type && i.quantity > 0).map(i => <option key={i.id} value={i.lote}>{i.lote} (Qtd: {i.quantity})</option>)}</select></div>}
                <div className="col-span-2"><input placeholder="Nome Paciente" name="patient_name" value={form.patient_name} onChange={handleChange} required className="input-neon" /></div>
                {form.test_type === TestType.HCG ? <><input placeholder="Prontuário" name="prontuario" value={form.prontuario} onChange={handleChange} className="input-neon" /><input placeholder="Identidade" name="patient_id" value={form.patient_id} onChange={handleChange} className="input-neon" /></> : <input placeholder="CPF/RG" name="patient_id" value={form.patient_id} onChange={handleChange} className="input-neon" />}
                <input type="date" name="birth_date" value={form.birth_date} onChange={handleChange} required className="input-neon" />
                <select name="sex" value={form.sex} onChange={handleChange} className="input-neon"><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option></select>
                <input placeholder="Unidade" name="execution_unit" value={form.execution_unit} onChange={handleChange} required className="input-neon" />
                <input placeholder="Técnico" name="technician_name" value={form.technician_name} onChange={handleChange} required className="input-neon" />
                <input type="date" name="sample_collection_date" value={form.sample_collection_date} onChange={handleChange} required className="input-neon" />
                {form.test_type === TestType.DENGUE && <div className="col-span-2 bg-gray-800 p-2 rounded grid grid-cols-2 gap-2"><input type="date" name="symptom_start_date" value={form.symptom_start_date} onChange={handleChange} className="input-neon" /><select name="result" value={form.result} onChange={handleChange} className="input-neon border-brand-primary">{Object.values(DengueResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>}
                {form.test_type === TestType.COVID && <div className="col-span-2 bg-gray-800 p-2 rounded grid grid-cols-2 gap-2"><input placeholder="Cidade" name="city" value={form.city} onChange={handleChange} className="input-neon" /><input placeholder="Fabricante" name="manufacturer" value={form.manufacturer} onChange={handleChange} className="input-neon" /><select name="sample_type" value={form.sample_type} onChange={handleChange} className="input-neon"><option value="swab nasal">Swab Nasal</option><option value="swab nasofaríngeo">Swab Nasofaríngeo</option></select><select name="result" value={form.result} onChange={handleChange} className="input-neon border-brand-primary">{Object.values(CovidResult).map(r => <option key={r} value={r}>{r}</option>)}</select></div>}
                {form.test_type === TestType.HCG && <div className="col-span-2 bg-gray-800 p-2 rounded"><label className="text-brand-primary text-xs">Resultado (Valor Referência)</label><select name="result_value" value={form.result_value} onChange={handleChange} className="input-neon border-brand-primary"><option value="">Selecione...</option><option value="POSITIVO">POSITIVO</option><option value="NEGATIVO">NEGATIVO</option></select></div>}
              </div>
              <div className="flex justify-end gap-2 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-700 rounded">Cancelar</button><button type="submit" className="px-4 py-2 bg-brand-primary text-black font-bold rounded shadow-neon">Salvar</button></div>
            </form>
          </ModalWrapper>
        );
      };

      const Dashboard = ({ setPage, openNew }) => {
        const { reports, stock } = useContext(AppContext);
        const low = stock.filter(i => i.quantity <= 5);
        return (
          <div className="p-6 space-y-6 animate-pop-in">
            <header className="flex justify-between items-center"><h1 className="text-3xl font-bold text-brand-primary tracking-widest">DASHBOARD</h1><button onClick={openNew} className="bg-brand-primary text-black px-6 py-3 rounded font-bold shadow-neon hover:scale-105 transition-transform flex gap-2"><Icons.Plus /> NOVO LAUDO</button></header>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-brand-surface p-4 rounded border border-gray-800 flex items-center gap-4"><div className="p-3 bg-blue-900/30 rounded text-blue-400"><Icons.Report /></div><div><p className="text-gray-400">Total Laudos</p><p className="text-3xl font-bold">{reports.length}</p></div></div>
                <div className="bg-brand-surface p-4 rounded border border-gray-800 flex items-center gap-4"><div className="p-3 bg-green-900/30 rounded text-brand-primary"><Icons.Box /></div><div><p className="text-gray-400">Estoque Total</p><p className="text-3xl font-bold">{stock.reduce((a, b) => a + b.quantity, 0)}</p></div></div>
                <div className="bg-brand-surface p-4 rounded border border-gray-800 flex items-center gap-4"><div className="p-3 bg-red-900/30 rounded text-danger"><Icons.Home /></div><div><p className="text-gray-400">Baixo Estoque</p><p className="text-3xl font-bold">{low.length}</p></div></div>
            </div>
            {/* CARDS FALTANTES RESTAURADOS AQUI */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="bg-brand-surface p-4 rounded border border-gray-800 h-64 overflow-y-auto">
                    <h3 className="text-warning font-bold mb-2 flex items-center gap-2"><Icons.Alert color="text-warning"/> Alerta Estoque</h3>
                    <ul>{low.length === 0 ? <p className="text-gray-500 text-sm">Estoque normal.</p> : low.map(i => <li key={i.id} className="flex justify-between border-b border-gray-800 py-1 text-sm"><span>{i.test_type.split('-')[0]}</span><span className="text-danger font-bold">{i.quantity}</span></li>)}</ul>
                </div>
                <div className="lg:col-span-2 bg-brand-surface p-4 rounded border border-gray-800 h-64 overflow-y-auto">
                    <h3 className="text-brand-primary font-bold mb-2 flex items-center gap-2"><Icons.Report color="text-brand-primary"/> Últimos Laudos</h3>
                    <table className="w-full text-sm text-left text-gray-300">
                        <thead className="text-gray-500"><tr><th>Paciente</th><th>Teste</th><th>Data</th></tr></thead>
                        <tbody>{reports.slice(0, 5).map(r => <tr key={r.id} className="border-b border-gray-800"><td className="py-1">{r.patient_name}</td><td className="text-brand-primary">{r.test_type.split('-')[0]}</td><td>{new Date(r.report_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td></tr>)}</tbody>
                    </table>
                </div>
            </div>
            <div className="w-full aspect-video rounded-lg overflow-hidden border border-gray-800 shadow-neon opacity-80"><img src="https://www.tjpb.jus.br/sites/default/files/media/2022/12/WhatsApp_Image_2022-12-01_at_10.37.10.jpeg" className="w-full h-full object-cover" /></div>
          </div>
        );
      };

      const ReportsList = ({ autoOpen, setAutoOpen }) => {
        const { reports, deleteReport } = useContext(AppContext);
        const [search, setSearch] = useState('');
        const [modal, setModal] = useState(false);
        const [edit, setEdit] = useState(null);
        const [del, setDel] = useState(null);
        const [pdf, setPdf] = useState(null);

        useEffect(() => { if (autoOpen) { setEdit(null); setModal(true); setAutoOpen(false); } }, [autoOpen]);

        return (
          <div className="p-6 h-full flex flex-col animate-pop-in">
            <header className="flex justify-between mb-4"><h1 className="text-3xl font-bold text-brand-primary">LAUDOS</h1><button onClick={() => { setEdit(null); setModal(true) }} className="bg-brand-primary text-black px-4 py-2 rounded font-bold flex gap-2"><Icons.Plus /> NOVO</button></header>
            <input placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} className="input-neon w-64 mb-4" />
            <div className="flex-1 bg-brand-surface border border-gray-800 rounded overflow-auto">
              <table className="w-full text-left text-sm text-gray-300"><thead className="bg-gray-900 text-brand-secondary sticky top-0"><tr><th className="p-3">Paciente</th><th>Exame</th><th>Data</th><th>Ações</th></tr></thead><tbody>{(reports || []).filter(r => (r.patient_name || '').toLowerCase().includes(search.toLowerCase())).map(r => <tr key={r.id} className="border-b border-gray-800 hover:bg-gray-800"><td className="p-3 font-bold text-white">{r.patient_name}</td><td>{r.test_type}</td><td>{new Date(r.report_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td><td className="flex gap-2 p-3"><button onClick={() => setPdf(r)} className="text-brand-primary"><Icons.Download /></button><button onClick={() => { setEdit(r); setModal(true) }} className="text-warning"><Icons.Pencil /></button><button onClick={() => setDel(r)} className="text-danger"><Icons.Trash /></button></td></tr>)}</tbody></table>
            </div>
            {modal && <ReportForm onClose={() => setModal(false)} initialData={edit} />}
            {del && <ConfirmationModal title="Excluir" message="Confirma?" onClose={() => setDel(null)} onConfirm={async () => { await deleteReport(del.id); setDel(null) }} />}
            {pdf && <ReportPDF report={pdf} onDone={() => setPdf(null)} />}
          </div>
        );
      };

      const Inventory = () => {
        const { stock, saveStock, deleteStock } = useContext(AppContext);
        const [modal, setModal] = useState(false);
        const [edit, setEdit] = useState(null);
        const [del, setDel] = useState(null);
        const [form, setForm] = useState({});

        useEffect(() => { setForm(edit || { test_type: TestType.DENGUE, lote: '', validade: '', quantity: 0 }); }, [edit, modal]);

        return (
          <div className="p-6 space-y-6 animate-pop-in h-full flex flex-col">
            <header className="flex justify-between"><h1 className="text-3xl font-bold text-brand-primary">ESTOQUE</h1><button onClick={() => { setEdit(null); setModal(true) }} className="bg-brand-primary text-black px-4 py-2 rounded font-bold flex gap-2"><Icons.Plus /> ADICIONAR</button></header>
            <div className="flex-1 bg-brand-surface border border-gray-800 rounded overflow-auto">
              <table className="w-full text-left"><thead className="bg-gray-900 text-brand-secondary sticky top-0"><tr><th className="p-3">Teste</th><th>Lote</th><th>Validade</th><th>Qtd</th><th>Ações</th></tr></thead><tbody>{stock.map(i => <tr key={i.id} className="border-b border-gray-800 hover:bg-gray-800"><td className="p-3">{i.test_type}</td><td>{i.lote}</td><td>{new Date(i.validade).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td><td className="font-bold">{i.quantity}</td><td className="flex gap-2 p-3"><button onClick={() => { setEdit(i); setModal(true) }} className="text-warning"><Icons.Pencil /></button><button onClick={() => setDel(i.id)} className="text-danger"><Icons.Trash /></button></td></tr>)}</tbody></table>
            </div>
            {modal && <ModalWrapper title={edit ? "Editar" : "Adicionar"} onClose={() => setModal(false)}><form onSubmit={e => { e.preventDefault(); saveStock(form); setModal(false); }} className="space-y-4"><div><label>Tipo</label><select value={form.test_type} onChange={e => setForm({ ...form, test_type: e.target.value })} className="input-neon">{Object.values(TestType).map(t => <option key={t} value={t}>{t}</option>)}</select></div><div><label>Lote</label><input value={form.lote} onChange={e => setForm({ ...form, lote: e.target.value.toUpperCase() })} required className="input-neon" /></div><div><label>Validade</label><input type="date" value={form.validade} onChange={e => setForm({ ...form, validade: e.target.value })} required className="input-neon" /></div><div><label>Qtd</label><input type="number" value={form.quantity} onChange={e => setForm({ ...form, quantity: parseInt(e.target.value) || 0 })} required className="input-neon" /></div><div className="flex justify-end gap-2 pt-4"><button type="submit" className="bg-brand-primary text-black px-4 py-2 rounded font-bold">Salvar</button></div></form></ModalWrapper>}
            {del && <ConfirmationModal title="Excluir" message="Confirma?" onClose={() => setDel(null)} onConfirm={async () => { await deleteStock(del); setDel(null) }} />}
          </div>
        );
      };

      const Indicators = () => {
        const { indicators, saveIndicator, deleteIndicator } = useContext(AppContext);
        const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' });
        const [editing, setEditing] = useState(null);
        const [del, setDel] = useState(null);

        useEffect(() => { if (editing) setForm(editing); else setForm({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' }); }, [editing]);
        const handleSubmit = async (e) => { e.preventDefault(); await saveIndicator(form); if (editing) setEditing(null); setForm({ date: new Date().toISOString().split('T')[0], gmus: '', pressure: '', hgt: '', weight: '', height: '', professional: '' }); };
        const exportCSV = () => { const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,Data,Gmus,Pressao,HGT,Peso,Altura,Profissional\n" + indicators.map(i => `${i.date},${i.gmus},${i.pressure},${i.hgt},${i.weight},${i.height},${i.professional}`).join('\n')); link.download = "indicadores.csv"; link.click(); };

        return (
          <div className="p-6 space-y-6 animate-pop-in h-full flex flex-col">
            <h1 className="text-3xl font-bold text-brand-primary">INDICADORES</h1>
            <div className="bg-brand-surface p-4 rounded border border-gray-800">
              <form onSubmit={handleSubmit} className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <input type="date" value={form.date} onChange={e => setForm({ ...form, date: e.target.value })} className="input-neon" required />
                <input placeholder="G'mus" value={form.gmus} onChange={e => setForm({ ...form, gmus: e.target.value })} className="input-neon" required />
                <input placeholder="Pressão" value={form.pressure} onChange={e => setForm({ ...form, pressure: e.target.value })} className="input-neon" />
                <input placeholder="HGT" value={form.hgt} onChange={e => setForm({ ...form, hgt: e.target.value })} className="input-neon" />
                <input placeholder="Peso" value={form.weight} onChange={e => setForm({ ...form, weight: e.target.value })} className="input-neon" />
                <input placeholder="Altura" value={form.height} onChange={e => setForm({ ...form, height: e.target.value })} className="input-neon" />
                <input placeholder="Profissional" value={form.professional} onChange={e => setForm({ ...form, professional: e.target.value })} className="input-neon md:col-span-2" required />
                <button type="submit" className="bg-brand-secondary text-black font-bold rounded p-2 md:col-span-4">{editing ? 'ATUALIZAR' : 'REGISTRAR'}</button>
              </form>
            </div>
            <div className="flex-1 bg-brand-surface border border-gray-800 rounded overflow-auto p-4">
              <button onClick={exportCSV} className="mb-4 bg-brand-accent text-black px-3 py-1 rounded text-sm font-bold flex gap-2"><Icons.Download /> CSV</button>
              <table className="w-full text-left text-sm text-gray-300"><thead className="border-b border-gray-700 text-brand-primary"><tr><th>Data</th><th>G'mus</th><th>HGT</th><th>Prof</th><th>Ações</th></tr></thead><tbody>{indicators.map(i => <tr key={i.id} className="border-b border-gray-800"><td className="p-2">{new Date(i.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td><td>{i.gmus}</td><td>{i.hgt}</td><td>{i.professional}</td><td className="flex gap-2"><button onClick={() => setEditing(i)} className="text-warning"><Icons.Pencil /></button><button onClick={() => setDel(i.id)} className="text-danger"><Icons.Trash /></button></td></tr>)}</tbody></table>
            </div>
            {del && <ConfirmationModal title="Excluir" message="Confirma?" onClose={() => setDel(null)} onConfirm={async () => { await deleteIndicator(del); setDel(null) }} />}
          </div>
        );
      };

      // --- APP ROOT ---
      const App = () => {
        const [page, setPage] = useState('dashboard');
        const [data, setData] = useState({ reports: [], stock: [], indicators: [] });
        const [loading, setLoading] = useState(true);
        const [autoOpenReport, setAutoOpenReport] = useState(false);
        const [inventoryUnlock, setInventoryUnlock] = useState(false);
        const [pwdModal, setPwdModal] = useState(false);

        const fetchData = useCallback(async () => {
          try {
            const [r, s, i] = await Promise.all([
              supabaseClient.from('reports').select('*').order('created_at', { ascending: false }),
              supabaseClient.from('stock').select('*').order('test_type', { ascending: true }),
              supabaseClient.from('indicators').select('*').order('date', { ascending: false })
            ]);
            setData({ reports: r.data || [], stock: s.data || [], indicators: i.data || [] });
            setLoading(false);
          } catch (e) { console.error(e); }
        }, []);

        useEffect(() => { fetchData(); }, [fetchData]);

        // CRUD Global (Passado via Contexto)
        const actions = useMemo(() => ({
          saveReport: async (d) => {
            if (d.id) await supabaseClient.from('reports').update(d).eq('id', d.id);
            else {
              const { error } = await supabaseClient.from('reports').insert([d]);
              if (!error) {
                // Baixa de estoque
                const item = data.stock.find(i => i.lote === d.lote && i.test_type === d.test_type);
                if (item && item.quantity > 0) await supabaseClient.from('stock').update({ quantity: item.quantity - 1 }).eq('id', item.id);
              }
            }
            await fetchData();
          },
          deleteReport: async (id) => { await supabaseClient.from('reports').delete().eq('id', id); await fetchData(); },
          saveStock: async (d) => { if (d.id) await supabaseClient.from('stock').update(d).eq('id', d.id); else await supabaseClient.from('stock').insert([d]); await fetchData(); },
          deleteStock: async (id) => { await supabaseClient.from('stock').delete().eq('id', id); await fetchData(); },
          saveIndicator: async (d) => { if (d.id) await supabaseClient.from('indicators').update(d).eq('id', d.id); else await supabaseClient.from('indicators').insert([d]); await fetchData(); },
          deleteIndicator: async (id) => { await supabaseClient.from('indicators').delete().eq('id', id); await fetchData(); },
        }), [data.stock, fetchData]);

        if (loading) return <div className="h-screen w-full flex items-center justify-center bg-black text-brand-primary animate-pulse font-bold text-2xl">CARREGANDO SISTEMA...</div>;

        return (
          <AppContext.Provider value={{ ...data, ...actions }}>
            <div className="flex h-screen w-full bg-brand-dark font-sans text-white overflow-hidden">
              <aside className="w-20 lg:w-64 bg-black border-r border-gray-800 flex flex-col items-center lg:items-start py-6 transition-all duration-300">
                <div className="text-brand-primary font-bold text-2xl px-6 mb-10 hidden lg:block">UBS <span className="text-white">SYS</span></div>
                <nav className="w-full space-y-2 px-2">
                  <button onClick={() => setPage('dashboard')} className={`w-full p-3 rounded flex items-center gap-4 ${page === 'dashboard' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white'}`}><Icons.Home /><span className="hidden lg:block">Dashboard</span></button>
                  <button onClick={() => setPage('reports')} className={`w-full p-3 rounded flex items-center gap-4 ${page === 'reports' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white'}`}><Icons.Report /><span className="hidden lg:block">Laudos</span></button>
                  <button onClick={() => { if (inventoryUnlock) setPage('inventory'); else setPwdModal(true); }} className={`w-full p-3 rounded flex items-center gap-4 ${page === 'inventory' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white'}`}><Icons.Box /><span className="hidden lg:block">Estoque</span></button>
                  <button onClick={() => setPage('indicators')} className={`w-full p-3 rounded flex items-center gap-4 ${page === 'indicators' ? 'bg-brand-secondary text-black font-bold shadow-neon' : 'text-gray-400 hover:text-white'}`}><Icons.Stats /><span className="hidden lg:block">Indicadores</span></button>
                </nav>
              </aside>
              <main className="flex-1 relative overflow-hidden bg-brand-dark">
                {page === 'dashboard' && <Dashboard setPage={setPage} openNew={() => { setPage('reports'); setAutoOpenReport(true); }} />}
                {page === 'reports' && <ReportsList autoOpen={autoOpenReport} setAutoOpen={setAutoOpenReport} />}
                {page === 'inventory' && <Inventory />}
                {page === 'indicators' && <Indicators />}
              </main>
              {pwdModal && <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[100]"><div className="bg-brand-surface p-6 rounded border border-brand-primary"><h2 className="text-brand-primary font-bold mb-4">Senha de Acesso</h2><input type="password" autoFocus className="input-neon mb-4" onKeyDown={e => { if (e.key === 'Enter') { if (e.target.value === '159753') { setInventoryUnlock(true); setPage('inventory'); setPwdModal(false) } else alert('Senha incorreta') } }} /><button onClick={() => setPwdModal(false)} className="text-gray-400 w-full">Cancelar</button></div></div>}
              {/* Container invisível para renderizar o PDF */}
              <div id="pdf-root"></div>
            </div>
          </AppContext.Provider>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
